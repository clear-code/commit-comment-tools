#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
#
# Copyright (C) 2013  Haruka Yoshihara <yoshihara@clear-code.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

require "English"
require "pp" # for debug.

store = lambda do |name, date, read_rate, comment|
  unless comment.empty?
    @result[name][date] =
      {:read_rate => read_rate, :comment => comment.chomp}
  end
end

if ARGV.include?("-h") or ARGV.include?("--help")
  puts("Usage: #{$0} [REPORT_DIRECTORY]")
  puts("  e.g.: #{$0} report_directory")
  exit(true)
elsif ARGV.size > 1
  puts("Please specify only 1 arguments.")
  exit(false)
end

report_directory = ARGV.first || "."
report_files = Dir.glob(File.join(report_directory, "**", "*.txt"))

@result = {}

report_files.each do |report|
  name = File.basename(report, ".txt")
  @result[name] = {}

  date = ""
  read_rate = ""
  comment = ""

  File.read(report).each_line do |_line|
    line = _line.chomp
    case line
    when /\A(\d\d\d\d-\d+-\d+):(\d+)%:(.*)\z/
      store.call(name, date, read_rate, comment)
      date = $1
      read_rate = $2
      comment = $3
    when /\A\s+/
      comment << $POSTMATCH << "\n"
    end
  end

  store.call(name, date, read_rate, comment)
end

pp @result # for debug.
