#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require "optparse"
require "commit-comment-tools/repository-stats"

parser = OptionParser.new

parser.banner = <<-BANNER
Usage: #{$0} [options] REPOSITORY_PATH
BANNER

parser.on("-h", "--help", "Print this message and quit.") do
  $stderr.puts(parser.help)
  exit(true)
end

branch_prefix = ""
format = :csv
resolution = :day
since = nil

parser.on("--prefix=PREFIX", "Branch prefix") do |prefix|
  branch_prefix = prefix
end

available_formats = [:csv]
parser.on("-f=FORMAT", "--format=FORMAT", available_formats,
          "Output format",
          "available formats: [#{available_formats.join(', ')}]",
          "[#{format}]") do |_format|
  format = _format
end

available_resolutions = [:day, :week, :month]
parser.on("-R=RESOLUTION", "--resolution=RESOLUTION", available_resolutions,
          "Data resolution",
          "available resolutions: [#{available_resolutions.join(', ')}]",
          "[#{resolution}]") do |_resolution|
  resolution = _resolution
end

# TODO Implement to process this option
parser.on("--since=SINCE", "Same as git log --since") do |_since|
  since = _since
end

begin
  parser.parse!(ARGV)
rescue OptionParser::ParseError => error
  $stderr.puts(error.message)
  $stderr.puts(parser.help)
  exit(false)
end

unless ARGV.size == 1
  $stderr.puts(parser.help)
  exit(false)
end

repository_path = ARGV.shift

repository_stats = CommitCommentTools::RepositoryStats.new(repository_path,
                                                           branch_prefix,
                                                           resolution)
repository_stats.stats
