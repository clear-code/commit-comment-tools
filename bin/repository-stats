#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require "optparse"
require "commit-comment-tools/repository-stats"

parser = OptionParser.new

parser.on("-h", "--help", "Print this message and quit.") do
  $stderr.puts(parser.help)
  exit(true)
end

repository_path = nil
branch_prefix = ""
format = "csv"
resolution = :date

parser.on("-r=REPOSITORY", "--repository=REPOSITORY",
          "Git repository path") do |path|
  repository_path = path
end

parser.on("--prefix=PREFIX", "Branch prefix") do |prefix|
  branch_prefix = prefix
end

available_formats = ["csv"]
parser.on("-f=FORMAT", "--format=FORMAT", available_formats,
          "Output format",
          "available formats: [#{available_formats.join(', ')}]",
          "[#{format}]") do |_format|
  format = _format
end

available_resolutions = [:date, :week, :month]
parser.on("-R=RESOLUTION", "--resolution=RESOLUTION", available_resolutions,
          "Data resolution",
          "available resolutions: [#{available_resolutions.join(', ')}]",
          "[#{resolution}]") do |_resolution|
  resolution = _resolution
end

begin
  parser.parse!(ARGV)
rescue OptionParser::ParseError => error
  $stderr.puts(error.message)
  $stderr.puts(parser.help)
  exit(false)
end

if repository_path.nil?
  $stderr.puts(parser.help)
  exit(false)
end

repository_stats = CommitCommentTools::RepositoryStats.new(repository_path,
                                                           branch_prefix,
                                                           resolution)
repository_stats.stats
